<!DOCTYPE html> <html lang="en-US"> <head> <meta charset="UTF-8"> <meta http-equiv="X-UA-Compatible" content="IE=Edge"> <link rel="stylesheet" href="/assets/css/just-the-docs-default.css"> <link rel="stylesheet" href="/assets/css/just-the-docs-head-nav.css" id="jtd-head-nav-stylesheet"> <style id="jtd-nav-activation"> .site-nav > ul.nav-list:first-child > li > a, .site-nav > ul.nav-list:first-child > li > ul > li > a, .site-nav > ul.nav-list:first-child > li > ul > li > ul > li:not(:nth-child(2)) > a { background-image: none; } .site-nav > ul.nav-list:not(:first-child) a, .site-nav li.external a { background-image: none; } .site-nav > ul.nav-list:first-child > li:nth-child(2) > ul > li:nth-child(5) > ul > li:nth-child(2) > a { font-weight: 600; text-decoration: none; }.site-nav > ul.nav-list:first-child > li:nth-child(2) > button svg, .site-nav > ul.nav-list:first-child > li:nth-child(2) > ul > li:nth-child(5) > button svg { transform: rotate(-90deg); }.site-nav > ul.nav-list:first-child > li.nav-list-item:nth-child(2) > ul.nav-list, .site-nav > ul.nav-list:first-child > li.nav-list-item:nth-child(2) > ul.nav-list > li.nav-list-item:nth-child(5) > ul.nav-list { display: block; } </style> <script async src="https://www.googletagmanager.com/gtag/js?id=G-W6M7DSFF4B"></script> <script> window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'G-W6M7DSFF4B', { 'anonymize_ip': true }); </script> <script src="/assets/js/vendor/lunr.min.js"></script> <script src="/assets/js/just-the-docs.js"></script> <meta name="viewport" content="width=device-width, initial-scale=1"> <link rel="icon" href="/favicon.ico" type="image/x-icon"> <!-- Begin Jekyll SEO tag v2.8.0 --> <title>Optimistic Concurrency Control (OCC) | Eventualize</title> <meta name="generator" content="Jekyll v4.3.2" /> <meta property="og:title" content="Optimistic Concurrency Control (OCC)" /> <meta property="og:locale" content="en_US" /> <meta name="description" content="A simple &amp; powerful event sourcing framework" /> <meta property="og:description" content="A simple &amp; powerful event sourcing framework" /> <link rel="canonical" href="http://localhost:4000/learn-more/main-mechanisms/occ.html" /> <meta property="og:url" content="http://localhost:4000/learn-more/main-mechanisms/occ.html" /> <meta property="og:site_name" content="Eventualize" /> <meta property="og:type" content="website" /> <meta name="twitter:card" content="summary" /> <meta property="twitter:title" content="Optimistic Concurrency Control (OCC)" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"WebPage","description":"A simple &amp; powerful event sourcing framework","headline":"Optimistic Concurrency Control (OCC)","publisher":{"@type":"Organization","logo":{"@type":"ImageObject","url":"http://localhost:4000/images/dark-theme-logo-horizontal.png"}},"url":"http://localhost:4000/learn-more/main-mechanisms/occ.html"}</script> <!-- End Jekyll SEO tag --> </head> <body> <a class="skip-to-main" href="#main-content">Skip to main content</a> <svg xmlns="http://www.w3.org/2000/svg" class="d-none"> <symbol id="svg-link" viewBox="0 0 24 24"> <title>Link</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-link"> <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path> </svg> </symbol> <symbol id="svg-menu" viewBox="0 0 24 24"> <title>Menu</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-menu"> <line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line> </svg> </symbol> <symbol id="svg-arrow-right" viewBox="0 0 24 24"> <title>Expand</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-chevron-right"> <polyline points="9 18 15 12 9 6"></polyline> </svg> </symbol> <!-- Feather. MIT License: https://github.com/feathericons/feather/blob/master/LICENSE --> <symbol id="svg-external-link" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-external-link"> <title id="svg-external-link-title">(external link)</title> <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path><polyline points="15 3 21 3 21 9"></polyline><line x1="10" y1="14" x2="21" y2="3"></line> </symbol> <symbol id="svg-doc" viewBox="0 0 24 24"> <title>Document</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-file"> <path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"></path><polyline points="13 2 13 9 20 9"></polyline> </svg> </symbol> <symbol id="svg-search" viewBox="0 0 24 24"> <title>Search</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-search"> <circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line> </svg> </symbol> <!-- Bootstrap Icons. MIT License: https://github.com/twbs/icons/blob/main/LICENSE.md --> <symbol id="svg-copy" viewBox="0 0 16 16"> <title>Copy</title> <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-clipboard" viewBox="0 0 16 16"> <path d="M4 1.5H3a2 2 0 0 0-2 2V14a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V3.5a2 2 0 0 0-2-2h-1v1h1a1 1 0 0 1 1 1V14a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1V3.5a1 1 0 0 1 1-1h1v-1z"/> <path d="M9.5 1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5v-1a.5.5 0 0 1 .5-.5h3zm-3-1A1.5 1.5 0 0 0 5 1.5v1A1.5 1.5 0 0 0 6.5 4h3A1.5 1.5 0 0 0 11 2.5v-1A1.5 1.5 0 0 0 9.5 0h-3z"/> </svg> </symbol> <symbol id="svg-copied" viewBox="0 0 16 16"> <title>Copied</title> <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-clipboard-check-fill" viewBox="0 0 16 16"> <path d="M6.5 0A1.5 1.5 0 0 0 5 1.5v1A1.5 1.5 0 0 0 6.5 4h3A1.5 1.5 0 0 0 11 2.5v-1A1.5 1.5 0 0 0 9.5 0h-3Zm3 1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5v-1a.5.5 0 0 1 .5-.5h3Z"/> <path d="M4 1.5H3a2 2 0 0 0-2 2V14a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V3.5a2 2 0 0 0-2-2h-1v1A2.5 2.5 0 0 1 9.5 5h-3A2.5 2.5 0 0 1 4 2.5v-1Zm6.854 7.354-3 3a.5.5 0 0 1-.708 0l-1.5-1.5a.5.5 0 0 1 .708-.708L7.5 10.793l2.646-2.647a.5.5 0 0 1 .708.708Z"/> </svg> </symbol> </svg> <div class="side-bar"> <div class="site-header" role="banner"> <a href="/" class="site-title lh-tight"> <div class="site-logo" role="img" aria-label="Eventualize"></div> </a> <button id="menu-button" class="site-button btn-reset" aria-label="Toggle menu" aria-pressed="false"> <svg viewBox="0 0 24 24" class="icon" aria-hidden="true"><use xlink:href="#svg-menu"></use></svg> </button> </div> <nav aria-label="Main" id="site-nav" class="site-nav"> <ul class="nav-list"><li class="nav-list-item"><a href="/" class="nav-list-link">Home</a></li><li class="nav-list-item"><button class="nav-list-expander btn-reset" aria-label="toggle items in Learn More category" aria-pressed="false"> <svg viewBox="0 0 24 24" aria-hidden="true"><use xlink:href="#svg-arrow-right"></use></svg> </button><a href="/learn-more/" class="nav-list-link">Learn More</a><ul class="nav-list"><li class="nav-list-item"><a href="/learn-more/why-should-i-use-it.html" class="nav-list-link">Why Should I Use It?</a></li><li class="nav-list-item"><a href="/learn-more/events.html" class="nav-list-link">Events</a></li><li class="nav-list-item"><a href="/learn-more/streams.html" class="nav-list-link">Streams</a></li><li class="nav-list-item"><a href="/learn-more/aggregates.html" class="nav-list-link">Aggregates</a></li><li class="nav-list-item"><button class="nav-list-expander btn-reset" aria-label="toggle items in Main Mechanisms category" aria-pressed="false"> <svg viewBox="0 0 24 24" aria-hidden="true"><use xlink:href="#svg-arrow-right"></use></svg> </button><a href="/learn-more/main-mechanisms/main-mechanisms.html" class="nav-list-link">Main Mechanisms</a><ul class="nav-list"><li class="nav-list-item"> <a href="/learn-more/main-mechanisms/snapshots.html" class="nav-list-link">Snapshots</a> </li><li class="nav-list-item"> <a href="/learn-more/main-mechanisms/occ.html" class="nav-list-link">Optimistic Concurrency Control (OCC)</a> </li></ul></li></ul></li><li class="nav-list-item"><a href="/quick-start.html" class="nav-list-link">Quick Start</a></li><li class="nav-list-item"><button class="nav-list-expander btn-reset" aria-label="toggle items in Contribution category" aria-pressed="false"> <svg viewBox="0 0 24 24" aria-hidden="true"><use xlink:href="#svg-arrow-right"></use></svg> </button><a href="/contribution/" class="nav-list-link">Contribution</a><ul class="nav-list"><li class="nav-list-item"><a href="/contribution/code-contribution.html" class="nav-list-link">Code Contribution</a></li></ul></li></ul> </nav> </div> <div class="main" id="top"> <div id="main-header" class="main-header"> <div class="search" role="search"> <div class="search-input-wrap"> <input type="text" id="search-input" class="search-input" tabindex="0" placeholder="Search Eventualize" aria-label="Search Eventualize" autocomplete="off"> <label for="search-input" class="search-label"><svg viewBox="0 0 24 24" class="search-icon"><use xlink:href="#svg-search"></use></svg></label> </div> <div id="search-results" class="search-results"></div> </div> <a class="site-button" href="https://github.com/outsidenote/eventualize" style="display: flex;flex-direction: row;"> <div style="height: 100%; width:30px;display:flex;align-items: center;"> <div style="object-fit: contain;"><img src="/images/github-logo.png" height="60"></div> </div> <small style="height:100%;display: flex;align-items: center;margin-left: 5px;">View on GitHub</small> </a> </div> <div class="main-content-wrap"> <nav aria-label="Breadcrumb" class="breadcrumb-nav"> <ol class="breadcrumb-nav-list"> <li class="breadcrumb-nav-list-item"><a href="/learn-more/">Learn More</a></li> <li class="breadcrumb-nav-list-item"><a href="/learn-more/main-mechanisms/main-mechanisms.html">Main Mechanisms</a></li> <li class="breadcrumb-nav-list-item"><span>Optimistic Concurrency Control (OCC)</span></li> </ol> </nav> <div id="main-content" class="main-content"> <main> <h1 id="optimistic-concurrency-control-occ"> <a href="#optimistic-concurrency-control-occ" class="anchor-heading" aria-labelledby="optimistic-concurrency-control-occ"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Optimistic Concurrency Control (OCC) </h1> <p>Optimistic Concurrency Control is a mechanism <code class="language-plaintext highlighter-rouge">Eventualize</code> uses in order to handle the a situation where multiple local aggregates would like to store events into the same stored aggregate.</p> <p>First, let’s understand why is that an issue that needs special handling.</p> <h2 id="the-issue-of-multiple-writers"> <a href="#the-issue-of-multiple-writers" class="anchor-heading" aria-labelledby="the-issue-of-multiple-writers"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> The Issue of Multiple Writers </h2> <p>Lets assume we have 2 service: service 1 and service 2.<br /> Both services created a local aggregate from the same stored aggregate “User: john”.<br /> Service 1 added the event “user earned points”.<br /> Service 2 added the event “user’s last earning cancelled”.<br /></p> <p><img src="../../images/multiple-writers-example.png" width="900" /></p> <p>As you can see, the order of stored events is important.<br /> If service 2 stores its event first, it’ll cancel the points earned before service 1’s event.<br /> If service 1 stores its event fisrt, than the event from service 2 will cancel these earned points.</p> <p><img src="../../images/multiple-writers-events-sequence-example.png" width="900" /></p> <p>How can we know which service should store its events first? How can we let the second serivce know that it’s going to store events based on a stale knowledge of the current state?</p> <h2 id="last-stored-sequence-id"> <a href="#last-stored-sequence-id" class="anchor-heading" aria-labelledby="last-stored-sequence-id"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Last Stored Sequence Id </h2> <p>When a local aggregate is created, it stores the sequence id of the latest event that was read into the <strong>Last Stored Sequence Id</strong> property.</p> <p><img src="../../images/fetch-aggregate-with-occ-example.png" width="900" /></p> <p><strong>Last Stored Sequence Id</strong> comes in handy when we want to store the local aggregate and make sure its state is up-to-date. Before actually performing the store operation, <code class="language-plaintext highlighter-rouge">Eventualize</code> checks that <strong>Last Stored Sequence Id</strong> is equal to the sequence id of the latest stored event. If it’s not, that mean that the local aggregate’s request to store pending events is based on a stale knowledge of the current state.</p> <p>Let’s return to our 2 application services example, and add a <strong>Last Stored Sequence Id</strong> to each local aggregate:</p> <p><img src="../../images/two-aggregates-with-occ-example.png" width="900" /></p> <p>Both local aggregate has a <strong>Last Stored Sequence Id</strong> with a value of 4. When both of the services try to store their pending events at the same time, one of them bound to be the first to succeed (race conditions). After a successful first store operation, the newly added event will receive the sequence id of 5.<br /> That means that the seond service to try and store its pending events will fail, because its <strong>Last Stored Sequence Id</strong> will still be 4.</p> <p>The mechanism described here is called <a href="https://en.wikipedia.org/wiki/Optimistic_concurrency_control"><strong>Optimistic Concurrency Control</strong></a>.</p> <p>The service that fails to store, will receive an <strong>OCC Exception</strong>. In that case it can refetch the up-to-date state and retry storing the event.</p> <h2 id="many-multiple-writers"> <a href="#many-multiple-writers" class="anchor-heading" aria-labelledby="many-multiple-writers"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Many Multiple Writers </h2> <p>What happens if instead of 2 services writes to the same Aggregate, we have 1,000? An example for that can be a service that receives IoT telemetries at large scale, and might have many instances of itself in order to injust the incoming traffic.</p> <p>If we perform an OCC check for each write, it’ll let a single instance succeed, but will fail the rest of 999 writers. In the next retry 998 writers would fail. And this is neglecting additional writes that might come in during this time. It’ll take forever to complete all the store operations!</p> <p>Usually, when we have a lot of different writers to the same aggregate, the events can be safely stored regardless of what the previous events are (unlike our 2 services example where the order of storage mattered a lot).</p> <p>For cases like this, you can let <code class="language-plaintext highlighter-rouge">Eventualize</code> know that a certain store operation can disregard OCC. When that happens, the events are stored with a sequence id that is incremented automatically for them based on the last sequence id that is already stored in the aggregate.</p> </main> </div> </div> <div class="search-overlay"></div> </div> <script src="https://cdn.jsdelivr.net/npm/mermaid@9.1.3/dist/mermaid.min.js"></script> <script> var config = { "securityLevel": 'loose', "theme": 'dark', };; mermaid.initialize(config); window.mermaid.init(undefined, document.querySelectorAll('.language-mermaid')); </script> </body> </html>
